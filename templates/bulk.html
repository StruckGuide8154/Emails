<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Mgr | Bulk Send</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        .bulk-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .editor-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        /* CSV Upload */
        .csv-upload-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .csv-upload-zone:hover,
        .csv-upload-zone.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .csv-upload-zone.loaded {
            border-color: var(--success);
            border-style: solid;
        }

        /* Header mapping */
        .mapping-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .mapping-row select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: inherit;
        }

        .mapping-row select option {
            background: #1a1a2e;
        }

        .mapping-label {
            min-width: 80px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Toolbar */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px 8px 0 0;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            color: var(--text-secondary);
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .toolbar-btn.active {
            background: rgba(99, 102, 241, 0.3);
            color: white;
            border-color: var(--primary-color);
        }

        .toolbar-sep {
            width: 1px;
            background: var(--glass-border);
            margin: 2px 4px;
        }

        .toolbar-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.8rem;
        }

        .toolbar-select option {
            background: #1a1a2e;
        }

        .toolbar-color {
            width: 28px;
            height: 28px;
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            padding: 0;
            cursor: pointer;
            background: none;
        }

        /* Rich text editor */
        .rich-editor {
            min-height: 250px;
            padding: 15px;
            border: 1px solid var(--glass-border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: rgba(0, 0, 0, 0.15);
            color: white;
            line-height: 1.6;
            overflow-y: auto;
            outline: none;
        }

        .rich-editor:focus {
            border-color: var(--primary-color);
        }

        .rich-editor:empty::before {
            content: 'Write your email here... Use {{variable}} for personalization';
            color: rgba(255, 255, 255, 0.3);
        }

        /* Advanced HTML dropdown */
        .advanced-section {
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .advanced-toggle:hover {
            color: white;
            background: rgba(0, 0, 0, 0.3);
        }

        .advanced-toggle i {
            transition: transform 0.3s;
        }

        .advanced-toggle.open i {
            transform: rotate(180deg);
        }

        .advanced-body {
            display: none;
            padding: 0;
        }

        .advanced-body.open {
            display: block;
        }

        .html-editor {
            width: 100%;
            min-height: 200px;
            background: rgba(0, 0, 0, 0.4);
            color: #a5f3a3;
            border: none;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            resize: vertical;
            box-sizing: border-box;
            outline: none;
            line-height: 1.5;
        }

        /* Gmail Preview */
        .preview-tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
        }

        .preview-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            font-family: inherit;
        }

        .preview-tab.active {
            color: white;
            border-bottom: 2px solid var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .preview-frame-wrap {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .gmail-preview {
            width: 100%;
            min-height: 100%;
            border: none;
        }

        /* Variable chips */
        .var-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .var-chip {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.4);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--accent-color);
            transition: all 0.2s;
        }

        .var-chip:hover {
            background: rgba(99, 102, 241, 0.4);
            color: white;
        }

        /* Progress bar */
        .send-progress {
            display: none;
            margin-top: 10px;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Status log */
        .send-log {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: none;
            margin-top: 10px;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-sent {
            color: var(--success);
        }

        .log-failed {
            color: var(--error);
        }

        .log-skipped {
            color: var(--text-secondary);
        }

        /* Docs panel */
        .docs-overlay {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(15, 15, 19, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            z-index: 1001;
            transition: right 0.3s;
            overflow-y: auto;
            padding: 30px;
            box-sizing: border-box;
        }

        .docs-overlay.open {
            right: 0;
        }

        .docs-overlay h3 {
            margin-top: 25px;
            color: var(--accent-color);
        }

        .docs-overlay code {
            background: rgba(99, 102, 241, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .docs-overlay pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .docs-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .docs-backdrop.open {
            display: block;
        }

        /* Section labels */
        .section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .csv-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .csv-info strong {
            color: white;
        }

        /* Recipient count badge */
        .recipient-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--success);
        }
    </style>
</head>

<body>
    <div class="dashboard-header glass" style="border-radius: 0; border-left: 0; border-right: 0; border-top: 0;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="/dashboard" class="glass-btn" style="padding: 5px 12px; font-size: 0.85rem; text-decoration: none;">
                <i class="ri-arrow-left-line"></i>
            </a>
            <div class="logo" style="font-size: 1.5rem;">
                <i class="ri-mail-send-line"></i> Bulk Send
            </div>
        </div>
        <div class="user-info">
            <button class="glass-btn" onclick="openDocs()" style="padding: 5px 15px; font-size: 0.85rem;">
                <i class="ri-book-2-line"></i> Docs
            </button>
            <span style="color: var(--text-secondary)">{{ email }}</span>
            <div class="avatar">{{ email[0].upper() }}</div>
        </div>
    </div>

    <div class="container" style="max-width: 1600px;">
        <div class="bulk-layout">
            <!-- Left: Editor Panel -->
            <div class="glass editor-panel">
                <!-- CSV Upload -->
                <div class="section-label">1. Upload Recipients</div>
                <div class="csv-upload-zone" id="csvZone">
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <i class="ri-upload-cloud-2-line" style="font-size: 2rem; color: var(--accent-color);"></i>
                    <p style="margin: 8px 0 0; color: var(--text-secondary);">
                        Click or drag a CSV file here
                    </p>
                </div>

                <!-- CSV Info & Mapping (hidden until CSV loaded) -->
                <div id="csvMappingSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="csv-info">
                            <i class="ri-file-text-line"></i>
                            <span id="csvFileName"></span> &mdash;
                            <span class="recipient-badge"><i class="ri-user-line"></i> <span id="recipientCount">0</span> recipients</span>
                        </div>
                        <button class="glass-btn" onclick="clearCsv()" style="padding: 3px 10px; font-size: 0.75rem;">
                            <i class="ri-close-line"></i> Clear
                        </button>
                    </div>

                    <div class="section-label" style="margin-top: 15px;">Map Email Column</div>
                    <div class="mapping-row">
                        <span class="mapping-label">Email field:</span>
                        <select id="emailColumnSelect" class="toolbar-select" style="flex: 1;"></select>
                    </div>

                    <div class="section-label" style="margin-top: 10px;">Available Variables</div>
                    <div class="var-chips" id="varChips"></div>
                </div>

                <!-- Subject -->
                <div class="section-label" style="margin-top: 5px;">2. Subject Line</div>
                <input type="text" id="subjectInput" class="glass-input" placeholder="Subject: e.g. Hey {{name}}, you're invited!">

                <!-- Rich Text Editor -->
                <div class="section-label">3. Email Body</div>
                <div>
                    <div class="editor-toolbar" id="editorToolbar">
                        <select class="toolbar-select" onchange="execFormat('formatBlock', this.value); this.selectedIndex=0;">
                            <option value="" disabled selected>Format</option>
                            <option value="h1">Heading 1</option>
                            <option value="h2">Heading 2</option>
                            <option value="h3">Heading 3</option>
                            <option value="p">Paragraph</option>
                        </select>
                        <select class="toolbar-select" onchange="execFontSize(this.value); this.selectedIndex=0;">
                            <option value="" disabled selected>Size</option>
                            <option value="1">Small</option>
                            <option value="3">Normal</option>
                            <option value="5">Large</option>
                            <option value="7">Huge</option>
                        </select>
                        <div class="toolbar-sep"></div>
                        <button type="button" class="toolbar-btn" onclick="execCmd('bold')" title="Bold"><i class="ri-bold"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('italic')" title="Italic"><i class="ri-italic"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('underline')" title="Underline"><i class="ri-underline"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('strikeThrough')" title="Strikethrough"><i class="ri-strikethrough"></i></button>
                        <div class="toolbar-sep"></div>
                        <input type="color" class="toolbar-color" value="#ffffff" onchange="execFormat('foreColor', this.value)" title="Text Color">
                        <input type="color" class="toolbar-color" value="#000000" onchange="execFormat('hiliteColor', this.value)" title="Highlight">
                        <div class="toolbar-sep"></div>
                        <button type="button" class="toolbar-btn" onclick="execCmd('justifyLeft')" title="Align Left"><i class="ri-align-left"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('justifyCenter')" title="Align Center"><i class="ri-align-center"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('justifyRight')" title="Align Right"><i class="ri-align-right"></i></button>
                        <div class="toolbar-sep"></div>
                        <button type="button" class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List"><i class="ri-list-unordered"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="Numbered List"><i class="ri-list-ordered"></i></button>
                        <div class="toolbar-sep"></div>
                        <button type="button" class="toolbar-btn" onclick="insertLink()" title="Insert Link"><i class="ri-link"></i></button>
                        <button type="button" class="toolbar-btn" onclick="insertImage()" title="Insert Image"><i class="ri-image-line"></i></button>
                        <button type="button" class="toolbar-btn" onclick="execCmd('removeFormat')" title="Clear Formatting"><i class="ri-format-clear"></i></button>
                    </div>
                    <div class="rich-editor" id="richEditor" contenteditable="true"></div>
                </div>

                <!-- Advanced HTML -->
                <div class="advanced-section">
                    <div class="advanced-toggle" id="advancedToggle">
                        <span><i class="ri-code-s-slash-line"></i> Advanced: Edit Raw HTML</span>
                        <i class="ri-arrow-down-s-line"></i>
                    </div>
                    <div class="advanced-body" id="advancedBody">
                        <textarea class="html-editor" id="htmlEditor" spellcheck="false"></textarea>
                        <div style="padding: 8px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="glass-btn" onclick="applyHtmlToEditor()" style="padding: 4px 12px; font-size: 0.8rem;">
                                Apply HTML to Editor
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Send -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="glass-btn" id="sendBulkBtn" onclick="startBulkSend()" style="padding: 12px 30px; font-size: 1rem;">
                        <i class="ri-send-plane-fill"></i> Send to All Recipients
                    </button>
                </div>

                <div class="send-progress" id="sendProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Sending 0/0...</div>
                </div>
                <div class="send-log" id="sendLog"></div>
            </div>

            <!-- Right: Preview Panel -->
            <div class="glass preview-panel">
                <div class="preview-tabs">
                    <button class="preview-tab active" onclick="setPreviewMode('light', this)">
                        <i class="ri-sun-line"></i> Gmail Light
                    </button>
                    <button class="preview-tab" onclick="setPreviewMode('dark', this)">
                        <i class="ri-moon-line"></i> Gmail Dark
                    </button>
                </div>
                <div style="padding: 12px 15px; border-bottom: 1px solid var(--glass-border); font-size: 0.85rem; color: var(--text-secondary);">
                    Preview updates live as you type. Variables shown with first recipient's data.
                </div>
                <div class="preview-frame-wrap">
                    <iframe id="previewFrame" class="gmail-preview"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Docs Slide-Over -->
    <div class="docs-backdrop" id="docsBackdrop" onclick="closeDocs()"></div>
    <div class="docs-overlay" id="docsPanel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;"><i class="ri-book-2-line"></i> Template Docs</h2>
            <button class="glass-btn" onclick="closeDocs()" style="padding: 5px 10px;"><i class="ri-close-line"></i></button>
        </div>

        <h3>Template Variables</h3>
        <p>Use double curly braces to insert personalized data from your CSV columns into each email.</p>
        <pre>Hello <b>{{name}}</b>,

You've been selected for <b>{{event}}</b>!

Best,
Your Team</pre>

        <h3>Available Variables</h3>
        <p>Variables are automatically created from your CSV column headers. For example, a CSV with headers:</p>
        <pre>name, email, school, year
John, john@asu.edu, ASU, Junior</pre>
        <p>Gives you these variables:</p>
        <ul>
            <li><code>{{name}}</code> &rarr; John</li>
            <li><code>{{email}}</code> &rarr; john@asu.edu</li>
            <li><code>{{school}}</code> &rarr; ASU</li>
            <li><code>{{year}}</code> &rarr; Junior</li>
        </ul>

        <h3>Email Column</h3>
        <p>After uploading a CSV, select which column contains the recipient email addresses using the dropdown. This is the address each email will be sent to.</p>

        <h3>Rich Text Editor</h3>
        <p>Use the toolbar to format your email with bold, italic, headings, lists, colors, links, and images. The preview panel shows exactly how it will appear in Gmail.</p>

        <h3>Advanced HTML</h3>
        <p>Expand the "Advanced: Edit Raw HTML" section to directly edit the email's HTML source. Click "Apply HTML to Editor" to sync changes back to the visual editor.</p>

        <h3>Preview</h3>
        <p>The right panel shows a 1:1 Gmail preview. Toggle between Light and Dark mode to see how your email renders for both types of Gmail users.</p>

        <h3>Tips</h3>
        <ul>
            <li>Emails are sent one-by-one sequentially for deliverability.</li>
            <li>Preview uses the first row of your CSV data for variable substitution.</li>
            <li>Always test with a small list first.</li>
            <li>Gmail may clip emails over 102KB.</li>
        </ul>
    </div>

    <script src="{{ url_for('static', filename='bulk.js') }}"></script>
</body>

</html>
